<!DOCTYPE html>
<html style="width:100%; height:100%">
<head>
    <% include partials/head.ejs %>
    <% include partials/search-bar-head.ejs %>

    <link rel="stylesheet" href="/css/navbar.css">

    <style>
        .my-line {
            fill: none;
            stroke-linejoin: round;
            stroke-linecap: round;
            stroke-width: 3;
        }

        .dot:hover {
            r: 10px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 10px;
            background: #f54;
            color: black;
            pointer-events: none;
            border-radius: 5px;
            border: 1px solid black;
        }

        .x-button {
            font-size: 3vw;
            position: absolute; 
            left: 10px; 
            top: 0px; 
            cursor: pointer; 
        }
        .x-button:hover {
            color: gray;
        }

        .chart-container {
            position: relative; 
            /*width: 45%;*/
            margin: 2%;
            float: left; 
            border: 1px solid black; 
            border-radius: 15px;
            /*-moz-transition: all 3s;
            -webkit-transition: all 3s;
            -o-transition: all 3s;*/
        }

        .autocomplete-suggestions { 
            border: 1px solid #000; 
            background: #fff; 
            cursor: pointer; 
            overflow: auto; 
            max-height: 65%;
        }

        .autocomplete-suggestion { 
            border-bottom: 2px solid #aaa; 
            padding: 10px 5px; 
            font-size: 2vh; 
            white-space: nowrap; 
            overflow: hidden; 

        }
        .autocomplete-selected { 
            background: #f54; 
        }

        .autocomplete-suggestions strong { 
            font-weight: bold; 
        }

        #search-box {
            font-size: 18px;
            width: 30%;
            vertical-align: top;
        }

        #search-button {
            padding: 0.5% 2%;
            vertical-align: top;
        }

        .layout-btn {
            border: 1px solid black;
            margin-left: -5px;
        }

        #nav-chart {
            border-bottom: 4px solid black;
            color: black;
        }
    </style>
</head>

<body style="width:100%; height:100%;">
    <% include partials/navbar.ejs %>


    <div style="text-align: center; margin-top: 2%">
    <h2>Search for a Course:</h2>
    <form id="search-form" onsubmit="onCourseSearch(); return false;" style="text-align:center;">
        <div style="display: inline-block; width: 100%; height: 100%;">
            <input type="text" id="search-box" style="width: 50%" required></input>
            <button type="submit" class="btn btn-danger" id="search-button" style="padding: 5px">Search</button>
        </div>
    </form>
    <div style="width: 80%; margin: 3% 10%">
        <form id="time-form" onsubmit="onRefresh(); return false;" style="float: left; width: 50%">
            <div style="width: 100%; height: 100%; text-align: center;">
                <div style="float:left">
                    <div>
                        From:
                        <input type="date" id="start-time" required></input>
                    </div>
                    <div>
                        To:  
                        <input type="date" id="end-time" required></input>
                    </div>
                </div>

                <div style="float:right">
                    Semester: 
                    <br />
                    <select id="semester-select">
                    </select>
                </div>

                <div style="clear:both; margin-top: 1%">
                    <br />
                    <button type="submit" class="btn btn-danger" id="time-button">Refresh</button>
                </div>
            </div>
        </form>

        <div style="float: right">
            <button class="layout-btn btn btn-default" id="top-layout-btn" style="border-top-right-radius: 0; border-bottom-right-radius: 0; float: left;" onclick="changeLayout(this)">
                <img src="/img/glyphicon-rows.png" />
            </button>
            <button class="layout-btn btn btn-default" id="side-layout-btn" style="border-top-left-radius: 0; border-bottom-left-radius: 0; background-color: lightgray; float: left" onclick="changeLayout(this)">
                <img src="/img/glyphicon-columns.png" />
            </button>
        </div>
    </div>
    <h3 id="info-title" style="clear:both; display: block;">&ensp;</h3>
    </div>


    <script type=text/javascript src="test.js"></script>
    <script>

        var startDate;
        var endDate;
        // may want to move this to some global available location
        var semester = "201701";
        var display_wide = false;
        var searchedCourses = new Set();

        // remove line chart
        function removeGraph(button) {
            var graph = $(button.parentNode)
            setTimeout(function() {
                graph.remove();
            }, 2000);

            // lazy way, fix later
            searchedCourses.delete(graph.attr("class").substring(16));

            graph.fadeOut(500, function() {
                graph.css({"visibility": "hidden", "display": "block"}).animate({width:"toggle"}, 500);
            });
        }

        // create line chart on form submit
        function onCourseSearch() {
            var course = $("#search-box").val();
            searchedCourses.add(course);

            d3.json("/api/" + semester + "/course/" + course, function(data) {
                genChart(data[course], course);
                $("#search-box").val("");
            });
        }

        // Update the time interval
        function onRefresh() {
            var startVal = $("#start-time").val();
            var endVal = $("#end-time").val();

            // update values from form
            startDate = startVal.substring(5) + "-" + startVal.substring(2, 4);
            endDate = endVal.substring(5) + "-" + endVal.substring(2, 4);
            semester = $("#semester-select :selected").text();

            $("#info-title").html("Data for: <i>" + startDate + "</i> to <i>" + endDate + "</i>");

            // date objects dont convert str to date x browser well, so just use strings
            var dateString = startDate + "_" + endDate;

            // refresh the already drawn classes
            for (var course of searchedCourses) {
                d3.json("/api/" + semester + "/" + course + "/" + dateString, function(data) {
                    // need a new variable because variable 'course' will be overriden one loop moves
                    // while this function is still asnyc running
                    var courseName = Object.keys(data)[0];
                    updateChart(data[courseName], courseName);
                });
            }
        }

        // change the way the graphs are displayed next to each other
        function changeLayout(button) {
            if (button["id"] == "top-layout-btn") {
                d3.selectAll(".chart-container")
                    .transition()
                    .duration(1000)
                    .style("width", "95%");

                $("#top-layout-btn").css("background-color", "lightgray").blur();
                $("#side-layout-btn").css("background-color", "white");
                display_wide = true;

            } else {
                d3.selectAll(".chart-container")
                    .transition()
                    .duration(1000)
                    .style("width", "45%");

                $("#top-layout-btn").css("background-color", "white");
                $("#side-layout-btn").css("background-color", "lightgray").blur();
                display_wide = false;

            }
        }

        // initialize search box for autocomplete and validation
        d3.json("/api/" + semester + "/courselist", function(data) {
            var searchBox = $("#search-box");

            searchBox.autocomplete({
                maxHeight: null,
                lookup: data,
                onSelect: function(selection) {
                    $("#search-box").val(selection['value']);
                }
            });

            var regex = ""
            data.forEach(function(d, i) {
                if (i == 0)
                    regex += d['value'];
                else
                    regex += "|" + d['value'];
            });

            searchBox.attr("pattern", regex);
        });

        // initialize semester list
        d3.json("/api/semesterlist", function(data) {
            var semesterlist = $("#semester-select");

            for (var semester of data) {
                var option = document.createElement("option");
                option.value = semester;
                option.innerHTML = semester;

                semesterlist.append(option);
            }
        });

    </script>
</body>
</html>